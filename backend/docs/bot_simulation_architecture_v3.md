# Redis + RabbitMQ 봇 시뮬레이션 전체 흐름 (v3)

## 변경사항 (v2 → v3)

| 구분 | v2 | v3 |
|------|----|----|
| API 호출 주기 | 5초 고정 | **기본 30초, 도착 임박 시 15초** |
| 버스 API | 미정의 | **공공데이터포탈 API 연동** |
| 지하철 API | 미정의 | **서울 열린데이터광장 API 연동** |
| 정류소 매칭 | 이름만 사용 | **좌표 기반 매칭 (상행/하행 구분)** |
| 프론트엔드 보간 | 없음 | **turf.js 경로 기반 보간** |
| ID 변환 | 없음 | **TMAP → 공공데이터 ID 변환 로직** |

---

## 목차

1. [전체 아키텍처](#1-전체-아키텍처)
2. [역할 분담](#2-역할-분담)
3. [API 호출 주기 설계](#3-api-호출-주기-설계)
4. [공공데이터 API 목록](#4-공공데이터-api-목록)
5. [TMAP → 공공데이터 ID 변환](#5-tmap--공공데이터-id-변환)
6. [경주 데이터 예시 (버스 + 지하철)](#6-경주-데이터-예시-버스--지하철)
7. [Phase 1: 경주 시작 및 ID 변환](#7-phase-1-경주-시작-및-id-변환)
8. [Phase 2: WALKING (도보 구간)](#8-phase-2-walking-도보-구간)
9. [Phase 3: WAITING_BUS (버스 대기)](#9-phase-3-waiting_bus-버스-대기)
10. [Phase 4: RIDING_BUS (버스 탑승)](#10-phase-4-riding_bus-버스-탑승)
11. [Phase 5: WAITING_SUBWAY (지하철 대기)](#11-phase-5-waiting_subway-지하철-대기)
12. [Phase 6: RIDING_SUBWAY (지하철 탑승)](#12-phase-6-riding_subway-지하철-탑승)
13. [Phase 7: 경주 종료](#13-phase-7-경주-종료)
14. [프론트엔드 보간 처리](#14-프론트엔드-보간-처리)
15. [전체 타임라인 요약](#15-전체-타임라인-요약)
16. [데이터 흐름 요약](#16-데이터-흐름-요약)
17. [부록](#17-부록)

---

## 1. 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 클라이언트                                    │
│                                     │                                        │
│                        ┌────────────┴────────────┐                          │
│                        ▼                         ▼                          │
│                   시작 버튼 클릭              SSE 연결                        │
│                        │                         ▲                          │
│                        │                         │                          │
│                        │              turf.js 보간 (30초 주기)               │
│                        │              → 부드러운 마커 이동                    │
└────────────────────────┼─────────────────────────┼──────────────────────────┘
                         │                         │
                         ▼                         │
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Django Server                                   │
│                                                                              │
│    ┌─────────────────┐                    ┌─────────────────┐               │
│    │  경주 시작 API   │                    │    SSE View     │               │
│    │                 │                    │                 │               │
│    │ POST /routes/   │                    │ GET /sse/routes │               │
│    │ {route_id}/start│                    │ /{route_id}     │               │
│    └────────┬────────┘                    └────────▲────────┘               │
│             │                                      │                        │
│             │ ID 변환 (1회)                         │                        │
│             ▼                                      │                        │
│    ┌─────────────────┐                             │                        │
│    │  공공데이터 API  │                             │                        │
│    │                 │                             │                        │
│    │ - 버스 노선 조회 │                             │                        │
│    │ - 정류소 조회    │                             │                        │
│    └─────────────────┘                             │                        │
│                                                    │                        │
└─────────────────────────────────────────────────────────────────────────────┘
                         │                         │
                         │                         │
                         ▼                         │
┌─────────────────────────────────────────────────────────────────────────────┐
│                               RabbitMQ                                       │
│                                                                              │
│    ┌─────────────────────────┐        ┌─────────────────────────┐           │
│    │     Celery Broker       │        │    Fanout Exchange      │           │
│    │                         │        │    (SSE Pub/Sub)        │           │
│    │  - Task 메시지 큐        │        │                         │           │
│    │  - 동적 주기 (15초/30초) │        │  Exchange:              │           │
│    │  - 실패 시 재시도        │        │  sse_events_101         │           │
│    └─────────────────────────┘        └─────────────────────────┘           │
│                                                  ▲                          │
└──────────────────────────────────────────────────┼──────────────────────────┘
                                                   │
┌──────────────────────────────────────────────────┼──────────────────────────┐
│                          Celery Worker           │                          │
│                                                  │                          │
│    ┌─────────────────────────────────────────────┴─────────────────┐        │
│    │                  update_bot_position                          │        │
│    │                                                               │        │
│    │    상태별 처리:                                                │        │
│    │    ┌─────────────────────────────────────────────────────┐   │        │
│    │    │ WAITING_BUS:                                        │   │        │
│    │    │   → 버스 도착정보 API (getArrInfoByRouteAll)         │   │        │
│    │    │   → 버스 위치정보 API (getBusPosByVehId)            │   │        │
│    │    │   → 주기: 도착 2분내 15초 / 그 외 30초              │   │        │
│    │    ├─────────────────────────────────────────────────────┤   │        │
│    │    │ RIDING_BUS:                                         │   │        │
│    │    │   → 버스 위치정보 API (getBusPosByVehId)            │   │        │
│    │    │   → 주기: 30초                                      │   │        │
│    │    ├─────────────────────────────────────────────────────┤   │        │
│    │    │ WAITING_SUBWAY:                                     │   │        │
│    │    │   → 지하철 도착정보 API (realtimeStationArrival)     │   │        │
│    │    │   → 지하철 위치정보 API (realtimePosition)          │   │        │
│    │    │   → 주기: 도착 2분내 15초 / 그 외 30초              │   │        │
│    │    ├─────────────────────────────────────────────────────┤   │        │
│    │    │ RIDING_SUBWAY:                                      │   │        │
│    │    │   → 지하철 위치정보 API (realtimePosition)          │   │        │
│    │    │   → 주기: 30초                                      │   │        │
│    │    └─────────────────────────────────────────────────────┘   │        │
│    └───────────────────────────────────────────────────────────────┘        │
│                              │                                               │
└──────────────────────────────┼──────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 Redis                                        │
│                                                                              │
│    ┌─────────────────────────┐        ┌─────────────────────────┐           │
│    │      봇 상태 캐시        │        │   공공데이터 ID 캐시     │           │
│    │                         │        │                         │           │
│    │  Key: bot_state:101     │        │  Key: public_ids:101    │           │
│    │  Value: {               │        │  Value: {               │           │
│    │    status: "RIDING_BUS",│        │    bus_route_id:        │           │
│    │    leg_index: 1,        │        │      "100100303",       │           │
│    │    vehicle_id: "11407.."│        │    bus_station_id:      │           │
│    │    arrival_time: 120    │        │      "118000108",       │           │
│    │  }                      │        │    bus_ars_id: "19193"  │           │
│    │                         │        │  }                      │           │
│    └─────────────────────────┘        └─────────────────────────┘           │
│                                                                              │
└──────────────────────────────┼──────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       공공데이터 API (외부)                                   │
│                                                                              │
│    ┌─────────────────────────┐        ┌─────────────────────────┐           │
│    │   서울시 버스 API        │        │  서울 열린데이터광장     │           │
│    │   (공공데이터포탈)       │        │   (지하철 API)          │           │
│    │                         │        │                         │           │
│    │  - getBusRouteList      │        │  - realtimeStation      │           │
│    │  - getStationByName     │        │    Arrival              │           │
│    │  - getArrInfoByRouteAll │        │  - realtimePosition     │           │
│    │  - getBusPosByVehId     │        │                         │           │
│    │                         │        │  일일 제한: 1000회       │           │
│    │  TPS: 30                │        │                         │           │
│    └─────────────────────────┘        └─────────────────────────┘           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 역할 분담

| 도구 | 역할 | 상세 |
|------|------|------|
| **RabbitMQ** | Celery 메시지 브로커 | Task 큐, 재시도, 동적 주기 |
| **RabbitMQ** | SSE Pub/Sub | Fanout Exchange, 메시지 유실 없음 |
| **Redis** | 봇 상태 캐시 | 빠른 읽기/쓰기 |
| **Redis** | 공공데이터 ID 캐시 | TMAP→공공데이터 변환 결과 저장 |
| **PostgreSQL** | 영속 데이터 | 유저, 경로, 경주 결과 |
| **공공데이터 API** | 실시간 정보 | 버스/지하철 도착정보, 위치정보 |

---

## 3. API 호출 주기 설계

### 3.1 트래픽 제한 고려

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         일일 트래픽 계산                                     │
│                                                                              │
│  지하철 API 일일 제한: 1000회                                                │
│                                                                              │
│  30초 주기:                                                                  │
│  - 1시간당: 120회                                                            │
│  - 1000회로 사용 가능: 약 8.3시간 ✅                                         │
│                                                                              │
│  15초 주기 (도착 임박 시):                                                   │
│  - 1시간당: 240회                                                            │
│  - 도착 임박 구간은 약 2분이므로 영향 적음                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 상황별 호출 주기

| 상태 | 조건 | 호출 주기 |
|------|------|----------|
| WAITING_BUS | 도착 2분 초과 | 30초 |
| WAITING_BUS | 도착 2분 이내 | **15초** |
| RIDING_BUS | - | 30초 |
| WAITING_SUBWAY | 도착 2분 초과 | 30초 |
| WAITING_SUBWAY | 도착 2분 이내 | **15초** |
| RIDING_SUBWAY | - | 30초 |
| WALKING | - | 30초 (API 호출 없음) |

### 3.3 동적 주기 결정 로직

```python
def get_polling_interval(status: str, arrival_time_seconds: int | None) -> int:
    """
    상태와 도착 예정 시간에 따라 API 호출 주기 결정
    
    Args:
        status: 봇 상태
        arrival_time_seconds: 도착 예정 시간 (초), None이면 정보 없음
    
    Returns:
        호출 주기 (초)
    """
    if status in ["WAITING_BUS", "WAITING_SUBWAY"]:
        if arrival_time_seconds is not None and arrival_time_seconds <= 120:
            return 15  # 도착 임박: 15초
        return 30  # 일반 대기: 30초
    
    return 30  # 그 외: 30초
```

---

## 4. 공공데이터 API 목록

### 4.1 버스 API (서울시 공공데이터포탈)

| API | URL | 용도 | 호출 시점 |
|-----|-----|------|----------|
| `getBusRouteList` | ws.bus.go.kr/api/rest/busRouteInfo/getBusRouteList | 버스번호 → route_id | 경주 시작 시 1회 |
| `getStationByNameList` | ws.bus.go.kr/api/rest/stationinfo/getStationByName | 정류소명 → stId, arsId | 경주 시작 시 1회 |
| `getArrInfoByRouteAll` | ws.bus.go.kr/api/rest/arrive/getArrInfoByRouteAll | 버스 도착정보 | WAITING_BUS 상태에서 반복 |
| `getBusPosByVehId` | ws.bus.go.kr/api/rest/buspos/getBusPosByVehId | 버스 실시간 위치 | RIDING_BUS 상태에서 반복 |

### 4.2 지하철 API (서울 열린데이터광장)

| API | URL | 용도 | 호출 시점 |
|-----|-----|------|----------|
| `realtimeStationArrival` | swopenAPI.seoul.go.kr/api/subway/{KEY}/json/realtimeStationArrival/{START}/{END}/{역명} | 도착 예정 열차 | WAITING_SUBWAY 상태에서 반복 |
| `realtimePosition` | swopenAPI.seoul.go.kr/api/subway/{KEY}/json/realtimePosition/{START}/{END}/{호선명} | 열차 위치 | RIDING_SUBWAY 상태에서 반복 |

---

## 5. TMAP → 공공데이터 ID 변환

### 5.1 변환이 필요한 이유

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ID 체계 불일치 문제                                   │
│                                                                              │
│  TMAP 응답:                                                                  │
│  - route: "지선:6625"                                                        │
│  - stationID: "754885" (TMAP 자체 ID)                                       │
│  - stationName: "신목초등학교입구"                                            │
│                                                                              │
│  공공데이터 API:                                                              │
│  - busRouteId: "100100303" (서울시 버스 노선 ID)                             │
│  - stId: "118000108" (서울시 정류소 ID)                                      │
│  - arsId: "19193" (정류소 고유번호)                                          │
│                                                                              │
│  → TMAP ID로는 공공데이터 API 호출 불가!                                      │
│  → 경주 시작 시 ID 변환 필요                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 버스 ID 변환 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           버스 ID 변환 흐름                                   │
│                                                                              │
│  TMAP BUS Leg:                                                               │
│  ┌───────────────────────────────────────────────────────────────────┐      │
│  │ route: "지선:6625"                                                 │      │
│  │ start.name: "신목초등학교입구"                                      │      │
│  │ start.lon: 126.870875                                              │      │
│  │ start.lat: 37.517294                                               │      │
│  └───────────────────────────────────────────────────────────────────┘      │
│                                      │                                      │
│                       ┌──────────────┴──────────────┐                       │
│                       ▼                             ▼                       │
│  ┌────────────────────────────┐    ┌────────────────────────────┐          │
│  │ 1. 버스 노선 ID 조회        │    │ 2. 정류소 ID 조회           │          │
│  │                            │    │                            │          │
│  │ API: getBusRouteList       │    │ API: getStationByNameList  │          │
│  │ strSrch: "6625"            │    │ stSrch: "신목초등학교"       │          │
│  │                            │    │                            │          │
│  │ 응답:                       │    │ 응답: (여러 개)             │          │
│  │ - busRouteId: 100100303    │    │ - stId: 118000107 (상행)   │          │
│  │ - busRouteNm: "6625" ✅    │    │ - stId: 118000108 (하행)   │          │
│  └────────────────────────────┘    └─────────────┬──────────────┘          │
│                                                  │                          │
│                                                  ▼                          │
│                              ┌────────────────────────────────┐             │
│                              │ 3. 좌표 기반 매칭              │             │
│                              │                                │             │
│                              │ TMAP 좌표: (126.870875,        │             │
│                              │            37.517294)          │             │
│                              │                                │             │
│                              │ 정류소 1: 거리 21m             │             │
│                              │ 정류소 2: 거리 10m ✅ 선택     │             │
│                              │                                │             │
│                              │ → stId: 118000108              │             │
│                              │ → arsId: 19193                 │             │
│                              └────────────────────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 좌표 기반 정류소 매칭 (상행/하행 구분)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       좌표 기반 정류소 매칭 예시                              │
│                                                                              │
│  문제: 같은 이름의 정류소가 도로 양쪽에 2개 존재 (상행/하행)                   │
│                                                                              │
│  검색: getStationByNameList(stSrch="문래역3번출구")                          │
│                                                                              │
│  응답:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ [정류소 1] stId: 118000107, arsId: 19192                            │    │
│  │            tmX: 126.8942227741, tmY: 37.5192330216                  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ [정류소 2] stId: 118000108, arsId: 19193                            │    │
│  │            tmX: 126.8944124856, tmY: 37.5190642533                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  TMAP 좌표: (126.8943, 37.51905277)                                         │
│                                                                              │
│  거리 계산 (Haversine):                                                      │
│  - 정류소 1: 약 21m                                                          │
│  - 정류소 2: 약 10m ✅ 선택 (가장 가까움)                                    │
│                                                                              │
│  결과: stId: 118000108, arsId: 19193                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 지하철 호선명 매핑

```python
SUBWAY_LINE_MAP = {
    "1호선": "1001",
    "2호선": "1002",
    "3호선": "1003",
    "4호선": "1004",
    "5호선": "1005",
    "6호선": "1006",
    "7호선": "1007",
    "8호선": "1008",
    "9호선": "1009",
    "경의중앙선": "1063",
    "공항철도": "1065",
    "경춘선": "1067",
    "수인분당선": "1075",
    "신분당선": "1077",
}

def parse_subway_line(tmap_route: str) -> str:
    """
    TMAP route에서 호선명 추출
    
    예시:
    - "수도권2호선" → "2호선"
    """
    if tmap_route.startswith("수도권"):
        return tmap_route[3:]
    return tmap_route
```

---

## 6. 경주 데이터 예시 (버스 + 지하철)

TMAP 응답 기준 경로:

```
leg[0]: WALK     출발지 → 신목초등학교입구     sectionTime: 15초
leg[1]: BUS      6625번 버스                  sectionTime: 657초 (8개 정류소)
                 신목초등학교입구 → 문래역3번출구
leg[2]: WALK     문래역3번출구 → 문래역        sectionTime: 157초
leg[3]: SUBWAY   2호선                        sectionTime: 533초 (5개 역)
                 문래 → 홍대입구
leg[4]: WALK     홍대입구역 → 도착지          sectionTime: 185초
```

---

## 7. Phase 1: 경주 시작 및 ID 변환

### 사용자가 시작 버튼 클릭

```
POST /api/v1/routes/{route_id}/start
```

### Django View 처리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Django View 처리                                   │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 1: PostgreSQL에 경주 시작 기록                                  │     │
│  │                                                                    │     │
│  │    route.start_time = now()                                       │     │
│  │    route.status = "RUNNING"                                       │     │
│  │    route.save()                                                   │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 2: TMAP → 공공데이터 ID 변환 (동기 처리)                        │     │
│  │                                                                    │     │
│  │    for leg in legs:                                               │     │
│  │        if leg.mode == "BUS":                                      │     │
│  │            # 버스 노선 ID 조회                                      │     │
│  │            bus_route_id = get_bus_route_id("6625")                │     │
│  │            # 정류소 ID 조회 (좌표 매칭)                             │     │
│  │            station_ids = get_station_ids(                         │     │
│  │                name="신목초등학교입구",                              │     │
│  │                tmap_lon=126.870875,                               │     │
│  │                tmap_lat=37.517294                                 │     │
│  │            )                                                      │     │
│  │                                                                    │     │
│  │        elif leg.mode == "SUBWAY":                                 │     │
│  │            # 호선명 파싱                                            │     │
│  │            subway_line = parse_subway_line("수도권2호선")          │     │
│  │            # → "2호선"                                             │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 3: Redis에 변환된 ID 저장                                      │     │
│  │                                                                    │     │
│  │    Key: public_ids:101                                            │     │
│  │    Value: {                                                       │     │
│  │        "legs": [                                                  │     │
│  │            { "mode": "WALK" },                                    │     │
│  │            {                                                      │     │
│  │                "mode": "BUS",                                     │     │
│  │                "bus_route_id": "100100303",                       │     │
│  │                "bus_route_name": "6625",                          │     │
│  │                "start_station": {                                 │     │
│  │                    "stId": "118000108",                           │     │
│  │                    "arsId": "19193",                              │     │
│  │                    "name": "신목초등학교입구"                       │     │
│  │                },                                                 │     │
│  │                "end_station": {                                   │     │
│  │                    "stId": "118000108",                           │     │
│  │                    "arsId": "19193",                              │     │
│  │                    "name": "문래역3번출구"                          │     │
│  │                }                                                  │     │
│  │            },                                                     │     │
│  │            { "mode": "WALK" },                                    │     │
│  │            {                                                      │     │
│  │                "mode": "SUBWAY",                                  │     │
│  │                "subway_line": "2호선",                             │     │
│  │                "subway_line_id": "1002",                          │     │
│  │                "start_station": "문래",                            │     │
│  │                "end_station": "홍대입구"                           │     │
│  │            },                                                     │     │
│  │            { "mode": "WALK" }                                     │     │
│  │        ]                                                          │     │
│  │    }                                                              │     │
│  │    TTL: 3600초                                                    │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 4: Redis에 봇 초기 상태 저장                                   │     │
│  │                                                                    │     │
│  │    Key: bot_state:101                                             │     │
│  │    Value: {                                                       │     │
│  │        "route_id": 101,                                           │     │
│  │        "bot_id": 1,                                               │     │
│  │        "status": "WALKING",                                       │     │
│  │        "current_leg_index": 0,                                    │     │
│  │        "leg_started_at": "2026-01-15T10:00:00",                   │     │
│  │        "vehicle_id": null,                                        │     │
│  │        "arrival_time": null,                                      │     │
│  │        "next_poll_interval": 30                                   │     │
│  │    }                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 5: Celery Task 최초 실행 예약                                  │     │
│  │                                                                    │     │
│  │    update_bot_position.apply_async(                               │     │
│  │        args=[route_id],                                           │     │
│  │        countdown=0  # 즉시 실행                                    │     │
│  │    )                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Phase 2: WALKING (도보 구간)

**소요시간: leg에 따라 다름 (15초 ~ 185초)**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Celery Task 실행 (WALKING)                            │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 1: Redis에서 봇 상태 조회                                       │     │
│  │                                                                    │     │
│  │    bot_state = redis_client.get_bot_state(101)                    │     │
│  │    → { status: "WALKING", leg_index: 0, leg_started_at: ... }     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 2: 시간 경과 체크 (API 호출 없음)                               │     │
│  │                                                                    │     │
│  │    elapsed = now() - leg_started_at                               │     │
│  │    section_time = legs[0]['sectionTime']  # 15초                  │     │
│  │    progress = (elapsed / section_time) * 100                      │     │
│  │                                                                    │     │
│  │    if elapsed >= section_time:                                    │     │
│  │        → 다음 leg로 전환                                            │     │
│  │        → 다음이 BUS면 WAITING_BUS로 변경                            │     │
│  │        → 다음이 SUBWAY면 WAITING_SUBWAY로 변경                      │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 3: SSE 이벤트 발행 + 다음 Task 예약                            │     │
│  │                                                                    │     │
│  │    rabbitmq_client.publish(                                       │     │
│  │        route_id=101,                                              │     │
│  │        event_type="bot_status_update",                            │     │
│  │        data={                                                     │     │
│  │            "status": "WALKING",                                   │     │
│  │            "leg_index": 0,                                        │     │
│  │            "progress_percent": 45,                                │     │
│  │            "next_update_in": 30                                   │     │
│  │        }                                                          │     │
│  │    )                                                              │     │
│  │                                                                    │     │
│  │    # 다음 Task 예약 (30초 후)                                       │     │
│  │    update_bot_position.apply_async(                               │     │
│  │        args=[route_id],                                           │     │
│  │        countdown=30                                               │     │
│  │    )                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Phase 3: WAITING_BUS (버스 대기)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Celery Task 실행 (WAITING_BUS)                          │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 1: Redis에서 봇 상태 + 공공데이터 ID 조회                       │     │
│  │                                                                    │     │
│  │    bot_state = redis_client.get_bot_state(101)                    │     │
│  │    public_ids = redis_client.get_public_ids(101)                  │     │
│  │                                                                    │     │
│  │    leg = public_ids["legs"][bot_state["leg_index"]]               │     │
│  │    → bus_route_id: "100100303"                                    │     │
│  │    → stId: "118000108"                                            │     │
│  │    → arsId: "19193"                                               │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 2: 버스 도착정보 API 호출                                       │     │
│  │                                                                    │     │
│  │    ┌─────────────────────────────────────────────────────────┐    │     │
│  │    │         getArrInfoByRouteAll API                        │    │     │
│  │    │                                                         │    │     │
│  │    │    Request:                                             │    │     │
│  │    │      stId: "118000108"                                  │    │     │
│  │    │      busRouteId: "100100303"                            │    │     │
│  │    │      ord: 정류소 순번                                    │    │     │
│  │    │                                                         │    │     │
│  │    │    Response:                                            │    │     │
│  │    │      {                                                  │    │     │
│  │    │        "vehId1": "114070504",                           │    │     │
│  │    │        "arrmsg1": "3분 20초 후 [2번째 전]",              │    │     │
│  │    │        "traTime1": 200,  ← 도착 예정 시간 (초)           │    │     │
│  │    │        "sectOrd1": 5,    ← 버스 현재 구간                │    │     │
│  │    │        "stationNm1": "양평신동아아파트"                   │    │     │
│  │    │      }                                                  │    │     │
│  │    └─────────────────────────────────────────────────────────┘    │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 3: 버스 실시간 위치 API 호출 (vehId가 있을 때)                  │     │
│  │                                                                    │     │
│  │    if vehId1 and vehId1 != "0":                                   │     │
│  │        ┌─────────────────────────────────────────────────────┐    │     │
│  │        │         getBusPosByVehId API                        │    │     │
│  │        │                                                     │    │     │
│  │        │    Request:                                         │    │     │
│  │        │      vehId: "114070504"                             │    │     │
│  │        │                                                     │    │     │
│  │        │    Response:                                        │    │     │
│  │        │      {                                              │    │     │
│  │        │        "tmX": 126.887492,  ← 경도                   │    │     │
│  │        │        "tmY": 37.522567,   ← 위도                   │    │     │
│  │        │        "stopFlag": 0       ← 0:운행중, 1:정차중     │    │     │
│  │        │      }                                              │    │     │
│  │        └─────────────────────────────────────────────────────┘    │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 4: 탑승 여부 확인                                              │     │
│  │                                                                    │     │
│  │    if traTime1 <= 0 또는 도착 메시지가 "도착":                      │     │
│  │        → 탑승 처리 (RIDING_BUS로 전환)                              │     │
│  │        → vehicle_id = vehId1 저장                                  │     │
│  │                                                                    │     │
│  │    else:                                                          │     │
│  │        → 계속 대기                                                  │     │
│  │        → arrival_time = traTime1 저장                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 5: 동적 주기 결정 + SSE 발행 + 다음 Task 예약                   │     │
│  │                                                                    │     │
│  │    # 동적 주기 결정                                                 │     │
│  │    if traTime1 <= 120:  # 2분 이내                                 │     │
│  │        next_interval = 15                                         │     │
│  │    else:                                                          │     │
│  │        next_interval = 30                                         │     │
│  │                                                                    │     │
│  │    rabbitmq_client.publish(                                       │     │
│  │        route_id=101,                                              │     │
│  │        event_type="bot_status_update",                            │     │
│  │        data={                                                     │     │
│  │            "status": "WAITING_BUS",                               │     │
│  │            "leg_index": 1,                                        │     │
│  │            "arrival_time": 200,                                   │     │
│  │            "arrival_message": "3분 20초 후 [2번째 전]",            │     │
│  │            "vehicle": {                                           │     │
│  │                "type": "BUS",                                     │     │
│  │                "route": "6625",                                   │     │
│  │                "vehId": "114070504",                              │     │
│  │                "position": {                                      │     │
│  │                    "lon": 126.887492,                             │     │
│  │                    "lat": 37.522567                               │     │
│  │                }                                                  │     │
│  │            },                                                     │     │
│  │            "next_update_in": next_interval                        │     │
│  │        }                                                          │     │
│  │    )                                                              │     │
│  │                                                                    │     │
│  │    update_bot_position.apply_async(                               │     │
│  │        args=[route_id],                                           │     │
│  │        countdown=next_interval                                    │     │
│  │    )                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 클라이언트 수신

```
event: bot_status_update
data: {
    "status": "WAITING_BUS",
    "arrival_time": 200,
    "arrival_message": "3분 20초 후 [2번째 전]",
    "vehicle": {
        "type": "BUS",
        "position": { "lon": 126.887492, "lat": 37.522567 }
    },
    "next_update_in": 30
}

→ 프론트: 버스 마커 표시 + turf.js로 30초간 보간 이동
```

---

## 10. Phase 4: RIDING_BUS (버스 탑승)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Celery Task 실행 (RIDING_BUS)                          │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 1: 버스 실시간 위치 API 호출                                    │     │
│  │                                                                    │     │
│  │    getBusPosByVehId(vehId=bot_state["vehicle_id"])                │     │
│  │                                                                    │     │
│  │    Response:                                                      │     │
│  │      { "tmX": 126.891500, "tmY": 37.519478, "stopFlag": 0 }      │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 2: 하차 정류소 도착 여부 확인                                   │     │
│  │                                                                    │     │
│  │    # 현재 버스 위치와 하차 정류소 좌표 비교                          │     │
│  │    end_station = public_ids["legs"][leg_index]["end_station"]     │     │
│  │    distance = calculate_distance(                                 │     │
│  │        bus_lat, bus_lon,                                          │     │
│  │        end_station["lat"], end_station["lon"]                     │     │
│  │    )                                                              │     │
│  │                                                                    │     │
│  │    if distance < 50:  # 50m 이내면 하차                            │     │
│  │        → 하차 처리 + 다음 leg로 전환                                 │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 3: SSE 발행 + 다음 Task 예약 (30초)                            │     │
│  │                                                                    │     │
│  │    rabbitmq_client.publish(                                       │     │
│  │        route_id=101,                                              │     │
│  │        event_type="bot_status_update",                            │     │
│  │        data={                                                     │     │
│  │            "status": "RIDING_BUS",                                │     │
│  │            "leg_index": 1,                                        │     │
│  │            "vehicle": {                                           │     │
│  │                "type": "BUS",                                     │     │
│  │                "route": "6625",                                   │     │
│  │                "vehId": "114070504",                              │     │
│  │                "position": {                                      │     │
│  │                    "lon": 126.891500,                             │     │
│  │                    "lat": 37.519478                               │     │
│  │                },                                                 │     │
│  │                "stopFlag": 0                                      │     │
│  │            },                                                     │     │
│  │            "next_update_in": 30                                   │     │
│  │        }                                                          │     │
│  │    )                                                              │     │
│  │                                                                    │     │
│  │    update_bot_position.apply_async(                               │     │
│  │        args=[route_id],                                           │     │
│  │        countdown=30                                               │     │
│  │    )                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. Phase 5: WAITING_SUBWAY (지하철 대기)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Celery Task 실행 (WAITING_SUBWAY)                         │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 1: 지하철 실시간 도착정보 API 호출                              │     │
│  │                                                                    │     │
│  │    ┌─────────────────────────────────────────────────────────┐    │     │
│  │    │         realtimeStationArrival API                      │    │     │
│  │    │                                                         │    │     │
│  │    │    URL: /realtimeStationArrival/0/10/문래               │    │     │
│  │    │                                                         │    │     │
│  │    │    Response (여러 열차):                                 │    │     │
│  │    │      {                                                  │    │     │
│  │    │        "subwayId": "1002",  ← 2호선                     │    │     │
│  │    │        "updnLine": "내선",  ← 방향                       │    │     │
│  │    │        "trainLineNm": "성수행 - 영등포구청방면",          │    │     │
│  │    │        "btrainNo": "2156",  ← 열차번호                  │    │     │
│  │    │        "barvlDt": 180,      ← 도착예정시간 (초)          │    │     │
│  │    │        "arvlMsg2": "전역 출발",                          │    │     │
│  │    │        "arvlMsg3": "영등포구청 출발",                     │    │     │
│  │    │        "bstatnNm": "성수"   ← 종착역                     │    │     │
│  │    │      }                                                  │    │     │
│  │    └─────────────────────────────────────────────────────────┘    │     │
│  │                                                                    │     │
│  │    # 방향 필터링: 하차역(홍대입구) 방향 열차만 선택                  │     │
│  │    target_train = filter_by_direction(trains, "홍대입구")         │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 2: 열차 위치정보 API 호출 (열차번호를 알 때)                    │     │
│  │                                                                    │     │
│  │    ┌─────────────────────────────────────────────────────────┐    │     │
│  │    │         realtimePosition API                            │    │     │
│  │    │                                                         │    │     │
│  │    │    URL: /realtimePosition/0/100/2호선                   │    │     │
│  │    │                                                         │    │     │
│  │    │    Response (해당 호선 모든 열차):                        │    │     │
│  │    │      {                                                  │    │     │
│  │    │        "trainNo": "2156",                               │    │     │
│  │    │        "statnNm": "영등포구청",  ← 현재 위치              │    │     │
│  │    │        "trainSttus": 2,  ← 0:진입,1:도착,2:출발          │    │     │
│  │    │        "updnLine": 0,    ← 0:상행/내선                   │    │     │
│  │    │        "statnTnm": "성수" ← 종착역                       │    │     │
│  │    │      }                                                  │    │     │
│  │    │                                                         │    │     │
│  │    │    # trainNo == "2156"인 열차 필터링                     │    │     │
│  │    └─────────────────────────────────────────────────────────┘    │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 3: 탑승 여부 확인                                              │     │
│  │                                                                    │     │
│  │    if barvlDt <= 0 또는 arvlMsg2 == "도착":                        │     │
│  │        → 탑승 처리 (RIDING_SUBWAY로 전환)                           │     │
│  │        → vehicle_id = btrainNo 저장                                │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 4: 동적 주기 + SSE 발행 + 다음 Task 예약                       │     │
│  │                                                                    │     │
│  │    next_interval = 15 if barvlDt <= 120 else 30                   │     │
│  │                                                                    │     │
│  │    rabbitmq_client.publish(                                       │     │
│  │        route_id=101,                                              │     │
│  │        event_type="bot_status_update",                            │     │
│  │        data={                                                     │     │
│  │            "status": "WAITING_SUBWAY",                            │     │
│  │            "leg_index": 3,                                        │     │
│  │            "arrival_time": 180,                                   │     │
│  │            "arrival_message": "전역 출발",                         │     │
│  │            "vehicle": {                                           │     │
│  │                "type": "SUBWAY",                                  │     │
│  │                "route": "2호선",                                  │     │
│  │                "trainNo": "2156",                                 │     │
│  │                "current_station": "영등포구청",                    │     │
│  │                "destination": "성수"                              │     │
│  │            },                                                     │     │
│  │            "next_update_in": next_interval                        │     │
│  │        }                                                          │     │
│  │    )                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. Phase 6: RIDING_SUBWAY (지하철 탑승)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Celery Task 실행 (RIDING_SUBWAY)                         │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 1: 열차 위치정보 API 호출                                       │     │
│  │                                                                    │     │
│  │    realtimePosition(subwayNm="2호선")                             │     │
│  │                                                                    │     │
│  │    # trainNo == bot_state["vehicle_id"]인 열차 필터링              │     │
│  │    → { "statnNm": "당산", "trainSttus": 2 }                       │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 2: 하차역 도착 여부 확인                                        │     │
│  │                                                                    │     │
│  │    end_station = public_ids["legs"][leg_index]["end_station"]     │     │
│  │    # end_station = "홍대입구"                                      │     │
│  │                                                                    │     │
│  │    if current_station == end_station:                             │     │
│  │        → 하차 처리 + 다음 leg로 전환                                 │     │
│  │                                                                    │     │
│  │    # 또는 passStopList에서 인덱스로 확인                            │     │
│  │    current_idx = get_station_index(current_station, passStopList) │     │
│  │    end_idx = get_station_index(end_station, passStopList)         │     │
│  │    if current_idx >= end_idx:                                     │     │
│  │        → 하차 처리                                                  │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Step 3: SSE 발행 + 다음 Task 예약 (30초)                            │     │
│  │                                                                    │     │
│  │    rabbitmq_client.publish(                                       │     │
│  │        route_id=101,                                              │     │
│  │        event_type="bot_status_update",                            │     │
│  │        data={                                                     │     │
│  │            "status": "RIDING_SUBWAY",                             │     │
│  │            "leg_index": 3,                                        │     │
│  │            "vehicle": {                                           │     │
│  │                "type": "SUBWAY",                                  │     │
│  │                "route": "2호선",                                  │     │
│  │                "trainNo": "2156",                                 │     │
│  │                "current_station": "당산",                         │     │
│  │                "current_station_index": 2,                        │     │
│  │                "total_stations": 5                                │     │
│  │            },                                                     │     │
│  │            "next_update_in": 30                                   │     │
│  │        }                                                          │     │
│  │    )                                                              │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 13. Phase 7: 경주 종료

마지막 WALK leg 완료 후 종료 처리 (v2와 동일)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           경주 종료 처리                                      │
│                                                                              │
│  1. 봇 상태 → FINISHED                                                       │
│  2. DB에 결과 저장 (end_time, duration)                                      │
│  3. 순위 계산                                                                 │
│  4. participant_finished 이벤트 발행                                         │
│  5. 모든 참가자 종료 시 route_ended 이벤트 발행                               │
│  6. Redis 정리 (bot_state, public_ids 삭제)                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 14. 프론트엔드 보간 처리

### 14.1 보간이 필요한 이유

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         30초 주기의 문제점                                    │
│                                                                              │
│  API 응답:    0초 ─────────────────────────────────────── 30초              │
│                │                                           │                │
│  실제 위치:   A ─────────────────────────────────────────→ B                │
│                                                                              │
│  보간 없이:   A에서 30초 멈춤 → B로 순간이동 ❌                               │
│  보간 적용:   A ─→─→─→─→─→─→─→─→─→─→─→─→─→─→─→─→─→ B ✅                     │
│                (부드럽게 이동)                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 14.2 turf.js 경로 기반 보간

TMAP `passShape.linestring`을 활용하여 실제 도로/철로 경로를 따라 보간합니다.

```javascript
import * as turf from '@turf/turf';

class RouteInterpolator {
  constructor(passShapeLinestring) {
    // TMAP passShape → LineString 변환
    this.routeLine = turf.lineString(
      passShapeLinestring.split(' ').map(coord => {
        const [lon, lat] = coord.split(',').map(Number);
        return [lon, lat];
      })
    );
    
    this.totalLength = turf.length(this.routeLine, { units: 'kilometers' });
    this.currentDistance = 0;
    this.currentSpeed = 0;
    this.lastUpdateTime = null;
  }
  
  updateFromAPI(lon, lat, stopFlag) {
    const now = Date.now();
    const currentPoint = turf.point([lon, lat]);
    
    // 현재 위치를 경로 위에 스냅
    const snapped = turf.nearestPointOnLine(this.routeLine, currentPoint);
    const newDistance = snapped.properties.location;
    
    // 속도 계산
    if (this.lastUpdateTime) {
      const timeDiff = (now - this.lastUpdateTime) / 1000 / 3600;
      const distanceDiff = newDistance - this.currentDistance;
      if (timeDiff > 0 && distanceDiff > 0) {
        this.currentSpeed = distanceDiff / timeDiff;
      }
    }
    
    if (stopFlag === 1) this.currentSpeed = 0;
    
    this.currentDistance = newDistance;
    this.lastUpdateTime = now;
  }
  
  getInterpolatedPosition() {
    if (!this.lastUpdateTime) return null;
    
    const elapsed = (Date.now() - this.lastUpdateTime) / 1000;
    const estimatedDistance = this.currentSpeed * (elapsed / 3600);
    const interpolatedDistance = Math.min(
      this.currentDistance + estimatedDistance,
      this.totalLength
    );
    
    const point = turf.along(this.routeLine, interpolatedDistance, { 
      units: 'kilometers' 
    });
    
    return {
      lon: point.geometry.coordinates[0],
      lat: point.geometry.coordinates[1]
    };
  }
}
```

### 14.3 버스 vs 지하철 보간

| 구분 | 버스 | 지하철 |
|------|------|--------|
| 경로 복잡도 | 높음 (도로) | 낮음 (거의 직선) |
| 속도 변화 | 큼 (신호, 정체) | 일정 |
| 보간 방식 | passShape 필수 | 단순 선형도 가능 |
| 정차 처리 | stopFlag 확인 | trainSttus 확인 |

---

## 15. 전체 타임라인 요약

| 시간 | Phase | 상태 | API 호출 | 주기 |
|------|-------|------|----------|------|
| 0:00 | 1 | 시작 | ID 변환 (1회) | - |
| 0:00~0:15 | 2 | WALKING | 없음 | 30초 |
| 0:15~10:00 | 3-4 | WAITING_BUS → RIDING_BUS | 도착정보 + 위치정보 | 15초/30초 |
| 10:00~12:37 | 2 | WALKING | 없음 | 30초 |
| 12:37~15:00 | 5 | WAITING_SUBWAY | 도착정보 + 위치정보 | 15초/30초 |
| 15:00~24:00 | 6 | RIDING_SUBWAY | 위치정보 | 30초 |
| 24:00~27:05 | 2 | WALKING | 없음 | 30초 |
| 27:05 | 7 | FINISHED | - | - |

---

## 16. 데이터 흐름 요약

```
┌─────────────┐   시작 요청     ┌─────────────┐   ID 변환     ┌─────────────┐
│  클라이언트  │ ───────────────▶│   Django    │ ────────────▶│  공공데이터   │
│             │                │             │ ◀────────────│    API      │
└──────▲──────┘                └──────┬──────┘              └─────────────┘
       │                              │
       │ SSE                          │ Task 예약
       │                              ▼
┌──────┴──────┐                ┌─────────────┐
│  RabbitMQ   │ ◀────────────── │  RabbitMQ   │
│  (Fanout)   │   이벤트 발행   │  (Celery)   │
└─────────────┘                └──────┬──────┘
                                      │
                                      │ Task 실행
                                      ▼
                               ┌─────────────┐
                               │   Celery    │
                               │   Worker    │
                               └──────┬──────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
             ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
             │    Redis    │   │  공공데이터   │   │ PostgreSQL  │
             │  (캐시)     │   │    API      │   │  (영속)     │
             └─────────────┘   └─────────────┘   └─────────────┘
```

---

## 17. 부록

### 17.1 봇 상태 구조 (v3)

```json
{
    "route_id": 101,
    "bot_id": 1,
    "status": "WAITING_BUS | RIDING_BUS | WAITING_SUBWAY | RIDING_SUBWAY | WALKING | FINISHED",
    "current_leg_index": 1,
    "total_legs": 5,
    "leg_started_at": "2026-01-15T10:00:00",
    "vehicle_id": "114070504",
    "arrival_time": 120,
    "next_poll_interval": 15
}
```

### 17.2 공공데이터 ID 캐시 구조

```json
{
    "legs": [
        { "mode": "WALK" },
        {
            "mode": "BUS",
            "bus_route_id": "100100303",
            "bus_route_name": "6625",
            "start_station": {
                "stId": "118000108",
                "arsId": "19193",
                "name": "신목초등학교입구",
                "lon": 126.8944,
                "lat": 37.5190
            },
            "end_station": { ... }
        },
        { "mode": "WALK" },
        {
            "mode": "SUBWAY",
            "subway_line": "2호선",
            "subway_line_id": "1002",
            "start_station": "문래",
            "end_station": "홍대입구",
            "pass_stops": ["문래", "영등포구청", "당산", "합정", "홍대입구"]
        },
        { "mode": "WALK" }
    ]
}
```

### 17.3 SSE 이벤트 종류 (v3 확장)

| 이벤트 | 설명 | 주요 데이터 |
|--------|------|-------------|
| `connected` | SSE 연결 성공 | `route_id` |
| `bot_status_update` | 봇 상태 업데이트 | `status`, `vehicle`, `arrival_time`, `next_update_in` |
| `bot_boarding` | 탑승 | `station_name`, `vehicle` |
| `bot_alighting` | 하차 | `station_name`, `next_action` |
| `participant_finished` | 도착 | `rank`, `duration` |
| `route_ended` | 경주 종료 | `reason` |

### 17.4 v2 대비 개선점

| 구분 | v2 | v3 |
|------|----|----|
| API 호출 주기 | 5초 고정 | 동적 (15초/30초) |
| 트래픽 효율 | 낮음 | **4~6배 절감** |
| ID 변환 | 미정의 | 경주 시작 시 1회 |
| 정류소 매칭 | 이름만 | **좌표 기반 (상행/하행 구분)** |
| 프론트 보간 | 없음 | **turf.js 경로 보간** |
| 버스/지하철 API | 미정의 | **상세 정의** |

---

*문서 버전: v3*
*작성일: 2026-01-16*
*기반 문서: Public API integration flow v1*
