# 🚍 유저 탑승 버스 실시간 도착 정보 모니터링 (SSE 연동)

본 문서는 유저가 배정받은 경로상의 버스 도착 정보를 실시간으로 추적하고, 이를 효율적으로 관리하기 위해 구현된 로직을 설명합니다.

## 1. 개요
유저가 경주 시작 시 선택한 경로(`user_leg_id`)에 포함된 버스 구간을 분석하여, 해당 버스가 출발 정류장에 언제 도착하는지 실시간으로 모니터링합니다. 이 정보는 백엔드 콘솔 로그와 브라우저 개발자 도구 콘솔에 실시간으로 출력됩니다.

## 2. 주요 구현 기능
### 1) 동적 노선 및 정류소 매칭
- **노선 ID 보정**: TMAP에서 제공하는 노선 ID와 서울시 공공데이터 ID가 다를 경우를 대비하여, 버스 번호(예: "N31", "6625")로 공공데이터 노선 ID를 재조회하는 Fallback 로직을 구현했습니다.
- **정류소 매칭**: TMAP의 정류소명과 공공데이터 API의 정류소명을 비교(정확히 일치, 공백 제거 일치, 부분 일치)하여 정확한 `stId`와 `ord`(순번)를 획득합니다.

### 2) API 호출 최적화 (Traffic Control)
공공데이터 API의 일일 호출 제한을 고려하여 다음과 같은 최적화 로직을 적용했습니다.
- **예상 도착 시간(ETA) 기반 활성화**: 경주 시작 시간 + 첫 도보 구간 소요 시간을 계산하여 **정류장 도착 예정 시각(ETA)**을 산출합니다.
- **시간 윈도우(Window)**: `ETA - 3분` 전부터 `ETA + 1분` 후까지만 API 조회를 활성화합니다.
- **조회 주기(Throttle)**: 활성화 구간 내에서도 **10초 간격**으로만 API를 호출하도록 제한했습니다.

## 3. 구현 상세
### 백엔드 (Backend)
- **Service**: `apps/routes/services/user_bus_monitor.py`
  - 버스 정보를 파싱하고 최적화 로직을 관리하는 `UserBusMonitor` 클래스 구현.
- **View**: `apps/routes/views.py` (SSEStreamView)
  - SSE 연결 유지 루프(5초 주기)에서 유저의 버스 상태를 체크하고, `ACTIVE` 상태일 때만 로그 출력 및 SSE 이벤트를 발송합니다.
  - **이벤트명**: `user_bus_arrival`

### 프론트엔드 (Frontend)
- **Hook**: `src/hooks/useRouteSSE.ts`
  - `user_bus_arrival` 이벤트 리스너를 등록했습니다.
  - 브라우저 개발자 도구 콘솔에서 `🚍 유저 탑승 버스 정보: { ... }` 형태로 실시간 데이터를 확인할 수 있습니다.

## 4. 확인 방법
1. **백엔드 콘솔**: 경주 시작 후 유저가 정류장 도착 3분 전이 되면 10초마다 버스 도착 로그가 출력됩니다.
2. **브라우저 콘솔**: 개발자 도구(F12) -> Console 탭에서 실시간 버스 정보 객체를 확인할 수 있습니다.

---
**Note**: 본 기능은 현재 테스트 모드(GPS 비활성)의 계획된 도보 시간을 기준으로 작동하며, 추후 GPS 연동 시 실제 위치 기반으로 전환이 가능하도록 설계되었습니다.
