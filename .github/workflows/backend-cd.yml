name: Backend CD (Deploy)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'docker-compose.django.yml'
      - 'docker-compose.celery.yml'
      - '.github/workflows/backend-cd.yml'

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: hadbetter-backend

jobs:
  build-and-push:
    name: ECR ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest

    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìžê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        id: image-info
        run: |
          IMAGE_TAG="${GITHUB_SHA::7}-$(date +%Y%m%d-%H%M%S)"
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        working-directory: ./backend
        run: |
          docker build \
            --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} \
            --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest \
            .

      - name: ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "## ðŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ${{ env.ECR_REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ env.ECR_REPOSITORY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  deploy-django:
    name: Django EC2 ë°°í¬
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Django EC2ì— ë°°í¬
        uses: appleboy/ssh-action@master
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        with:
          host: ${{ secrets.EC2_DJANGO_HOST }}
          username: ${{ secrets.EC2_DJANGO_USER }}
          key: ${{ secrets.EC2_DJANGO_SSH_KEY }}
          port: 22
          envs: IMAGE_TAG
          script: |
            # ìž‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/hadbetter

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ap-northeast-2 | \
              docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            # ìµœì‹  ì´ë¯¸ì§€ Pull
            docker pull ${{ secrets.ECR_REGISTRY }}/hadbetter-backend:${IMAGE_TAG}
            docker pull ${{ secrets.ECR_REGISTRY }}/hadbetter-backend:latest

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
            export IMAGE_TAG=${IMAGE_TAG}

            # Docker Composeë¡œ ìž¬ì‹œìž‘ (ë¬´ì¤‘ë‹¨ ë°°í¬)
            docker-compose -f docker-compose.django.yml pull
            docker-compose -f docker-compose.django.yml up -d --no-build

            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

            # ë°°í¬ í™•ì¸
            echo "Django ì„œë²„ ë°°í¬ ì™„ë£Œ: ${IMAGE_TAG}"
            docker-compose -f docker-compose.django.yml ps

      - name: í—¬ìŠ¤ ì²´í¬
        run: |
          sleep 10
          # ì¶”í›„ í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ ì‹œ í™œì„±í™”
          # curl -f http://${{ secrets.EC2_DJANGO_HOST }}/api/health || exit 1

  deploy-celery:
    name: Celery EC2 ë°°í¬
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Celery EC2ì— ë°°í¬
        uses: appleboy/ssh-action@master
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        with:
          host: ${{ secrets.EC2_CELERY_HOST }}
          username: ${{ secrets.EC2_CELERY_USER }}
          key: ${{ secrets.EC2_CELERY_SSH_KEY }}
          port: 22
          envs: IMAGE_TAG
          script: |
            # ìž‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/hadbetter

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ap-northeast-2 | \
              docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            # ìµœì‹  ì´ë¯¸ì§€ Pull
            docker pull ${{ secrets.ECR_REGISTRY }}/hadbetter-backend:${IMAGE_TAG}
            docker pull ${{ secrets.ECR_REGISTRY }}/hadbetter-backend:latest

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
            export IMAGE_TAG=${IMAGE_TAG}

            # Docker Composeë¡œ ìž¬ì‹œìž‘
            docker-compose -f docker-compose.celery.yml pull
            docker-compose -f docker-compose.celery.yml up -d --no-build

            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

            # ë°°í¬ í™•ì¸
            echo "Celery ì„œë²„ ë°°í¬ ì™„ë£Œ: ${IMAGE_TAG}"
            docker-compose -f docker-compose.celery.yml ps

  deployment-summary:
    name: ë°°í¬ ê²°ê³¼ ìš”ì•½
    needs: [build-and-push, deploy-django, deploy-celery]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ë°°í¬ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "## ðŸš€ Backend ë°°í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë¯¸ì§€ ë¹Œë“œ**: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Django EC2 ë°°í¬**: ${{ needs.deploy-django.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Celery EC2 ë°°í¬**: ${{ needs.deploy-celery.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-and-push.result }}" == "success" ] && \
             [ "${{ needs.deploy-django.result }}" == "success" ] && \
             [ "${{ needs.deploy-celery.result }}" == "success" ]; then
            echo "âœ… ëª¨ë“  ì„œë²„ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ì´ë¯¸ì§€ íƒœê·¸**: \`${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ì¼ë¶€ ë°°í¬ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi
